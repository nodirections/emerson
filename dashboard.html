<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MB Hydrometric — Map + Chart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Silence favicon 404 -->
  <link rel="icon" href="data:," />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height:100%; margin:0; font-family:system-ui, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { display:grid; grid-template-columns: 1fr 460px; grid-template-rows: 46px 1fr; height:100%; }
    .topbar { grid-column:1 / span 2; display:flex; align-items:center; gap:12px; padding:6px 10px; border-bottom:1px solid #eee; background:#fafafa; }
    .topbar h1 { font-size:16px; margin:0 8px 0 0; font-weight:600; }
    .grow { flex:1; }
    .map { grid-column:1; grid-row:2; }
    #map { width:100%; height:100%; min-height:300px; }
    .side { grid-column:2; grid-row:2; border-left:1px solid #eee; display:flex; flex-direction:column; min-width:280px; }
    .side-head { padding:8px 10px; border-bottom:1px solid #eee; display:flex; align-items:center; gap:10px; }
    .title { font-weight:600; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .controls { display:flex; gap:8px; align-items:center; }
    .controls select, .controls button { padding:6px 10px; border:1px solid #ccc; border-radius:8px; background:#fff; cursor:pointer; }
    iframe { border:0; width:100%; height:100%; min-height:300px; }
    .err { position:fixed; right:10px; bottom:10px; background:#fee; border:1px solid #c99; color:#900; padding:8px; border-radius:6px; display:none; max-width:80vw; }
    @media (max-width:980px){
      .wrap { grid-template-columns:1fr; grid-template-rows: 46px 50vh 50vh; }
      .map { grid-column:1; grid-row:2; }
      .side { grid-column:1; grid-row:3; border-left:0; border-top:1px solid #eee; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1>Manitoba Hydrometric — Map + Chart</h1>
      <div class="grow"></div>
      <div class="controls">
        <label>Mode:
          <select id="modeSel">
            <option value="realtime">Realtime (last 30 days)</option>
            <option value="daily">Daily mean (full record)</option>
          </select>
        </label>
        <button id="collapseBtn" title="Collapse/expand chart panel">&#8660;</button>
      </div>
    </div>

    <div class="map"><div id="map"></div></div>

    <aside class="side">
      <div class="side-head">
        <div class="title" id="sideTitle">Select a station...</div>
        <a id="openFull" href="#" target="_blank" rel="noopener" style="margin-left:auto; font-size:13px;">Open full page &#10138;</a>
      </div>
      <iframe id="chartFrame" title="Water level chart"></iframe>
    </aside>
  </div>

  <div id="err" class="err"></div>

  <!-- JS at end -->
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  (function(){
    "use strict";

    // ---- helpers ----
    function showErr(msg){
      var el = document.getElementById("err");
      el.textContent = msg;
      el.style.display = "block";
      console.error(msg);
    }
    function getParam(name, defVal){
      var u = new URL(location.href);
      var v = u.searchParams.get(name);
      return v == null ? defVal : v;
    }
    function setParams(params){
      var u = new URL(location.href);
      for (var k in params){
        var v = params[k];
        if (v == null || v === "") u.searchParams.delete(k);
        else u.searchParams.set(k, v);
      }
      history.replaceState(null, "", u.href);
    }

    // ---- compute chart base: https://nodirections.github.io/emerson/ ----
    var parts = location.pathname.split("/").filter(Boolean);
    var repo = parts[0] || "";
    var CHART_BASE = location.origin + "/" + repo + "/";

    // ---- state + elements ----
    var DEFAULT_STATION = "05OC001"; // change or remove if you prefer blank
    var currentStation = (getParam("station","") || DEFAULT_STATION).toUpperCase();
    var currentMode = (getParam("mode","realtime") === "daily") ? "daily" : "realtime";

    var modeSel = document.getElementById("modeSel");
    var frame = document.getElementById("chartFrame");
    var sideTitle = document.getElementById("sideTitle");
    var openFull = document.getElementById("openFull");
    var collapseBtn = document.getElementById("collapseBtn");
    modeSel.value = currentMode;

    function chartUrl(station, mode){
      if (!station) return "about:blank";
      var u = new URL(CHART_BASE);
      u.searchParams.set("station", station);
      if (mode === "daily") u.searchParams.set("mode", "daily");
      return u.href;
    }
    function setSidebar(station, titleText){
      currentStation = station;
      sideTitle.textContent = titleText || (station ? ("Station " + station) : "Select a station...");
      var url = chartUrl(station, currentMode);
      frame.src = url;
      openFull.href = url;
      setParams({station: station, mode: currentMode});
    }

    modeSel.addEventListener("change", function(){
      currentMode = modeSel.value;
      if (currentStation) setSidebar(currentStation);
    });
    collapseBtn.addEventListener("click", function(){
      var wrap = document.querySelector(".wrap");
      var collapsed = wrap.style.gridTemplateColumns && / 0px$/.test(wrap.style.gridTemplateColumns);
      wrap.style.gridTemplateColumns = collapsed ? "" : "1fr 0px";
    });

    // ---- ECCC + Leaflet ----
    function ecccStationsUrl(prov, limit){
      var p = new URLSearchParams({ PROV_TERR_STATE_LOC: prov, f: "json", lang: "en-CA", limit: String(limit || 10000) });
      return "https://api.weather.gc.ca/collections/hydrometric-stations/items?" + p.toString();
    }
    function fetchAllPages(firstUrl, maxPages){
      maxPages = maxPages || 50;
      var url = firstUrl;
      var all = [];
      var seen = {};
      var loops = 0;
      function next(){
        if (!url || seen[url] || loops >= maxPages) return Promise.resolve(all);
        seen[url] = true; loops++;
        return fetch(url).then(function(resp){
          if (!resp.ok) throw new Error("HTTP " + resp.status + " on " + url);
          return resp.json();
        }).then(function(geojson){
          if (geojson && Array.isArray(geojson.features)) all = all.concat(geojson.features);
          var links = (geojson && geojson.links) ? geojson.links : [];
          var i, nxt = null;
          for (i=0; i<links.length; i++){
            if (links[i] && links[i].rel === "next" && links[i].href){ nxt = links[i].href; break; }
          }
          url = nxt ? (new URL(nxt, location.href)).href : null;
          return next();
        });
      }
      return next();
    }
    function stationLabel(p){
      var s = p ? (p.OFFICIAL_NAME || p.WATERCOURSE_NAME || p.STATION_NAME) : "";
      return String(s || "").trim();
    }

    document.addEventListener("DOMContentLoaded", function(){
      // show a chart immediately so the page looks alive
      setSidebar(currentStation);

      if (!window.L){ showErr("Leaflet failed to load."); return; }

      try{
        var map = L.map("map", { preferCanvas: true });
        var mbCenter = [54.7, -97.5];
        map.setView(mbCenter, 5);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap contributors"
        }).addTo(map);

        fetchAllPages(ecccStationsUrl("MB")).then(function(feats){
          if (!feats || !feats.length){ showErr("No stations returned for MB."); return; }
          var group = L.featureGroup();

          for (var i=0; i<feats.length; i++){
            var f = feats[i];
            var coords = f && f.geometry && f.geometry.coordinates;
            var props = f && f.properties ? f.properties : {};
            if (!coords || coords.length < 2) continue;
            var lon = coords[0], lat = coords[1];
            var id = String(props.STATION_NUMBER || "").trim().toUpperCase();
            var name = stationLabel(props);
            var label = name ? (name + " (" + id + ")") : id;

            var m = L.marker([lat, lon]).on("click", (function(station, title){
              return function(){ setSidebar(station, title); };
            })(id, label));
            m.bindTooltip(label, { direction: "top", offset: [0, -6] });
            group.addLayer(m);

            if (id && id === currentStation){
              (function(lat0, lon0){ setTimeout(function(){ map.panTo([lat0, lon0]); }, 0); })(lat, lon);
            }
          }

          group.addTo(map);
          if (group.getLayers().length) map.fitBounds(group.getBounds().pad(0.1));
        }).catch(function(e){
          console.error(e);
          showErr("Failed to load hydrometric stations.");
        });
      }catch(e){
        console.error(e);
        showErr("Map initialization error. See console.");
      }
    });
  })();
  </script>
</body>
</html>
